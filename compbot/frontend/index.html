<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XTourney - Professional Tournament Platform</title>
    <style>
        :root {
            --primary: #5865F2;
            --primary-dark: #4752C4;
            --secondary: #57F287;
            --dark: #1a1a2e;
            --darker: #0f172a;
            --light: #f8fafc;
            --gray: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--darker);
            color: var(--light);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header */
        header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 15px 0;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: bold;
            color: var(--light);
        }
        
        .logo span {
            color: var(--primary);
        }
        
        .auth-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .btn {
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-size: 14px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--light);
            border: 1px solid var(--gray);
        }
        
        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid var(--primary);
        }
        
        .user-info {
            text-align: left;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .user-role {
            font-size: 12px;
            color: var(--gray);
        }
        
        /* Hero Section */
        .hero {
            padding: 80px 0;
            text-align: center;
            background: linear-gradient(135deg, var(--darker) 0%, #1e293b 100%);
        }
        
        .hero h1 {
            font-size: 3.5rem;
            margin-bottom: 20px;
            background: linear-gradient(90deg, var(--primary), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .hero p {
            font-size: 1.2rem;
            color: var(--gray);
            max-width: 600px;
            margin: 0 auto 40px;
        }
        
        /* Dashboard */
        .dashboard {
            display: none;
            min-height: calc(100vh - 200px);
        }
        
        .sidebar {
            width: 280px;
            background: rgba(15, 23, 42, 0.8);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px 20px;
            position: fixed;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        
        .main-content {
            flex: 1;
            padding: 30px;
            margin-left: 280px;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--gray);
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--light);
        }
        
        .nav-item.active {
            background: rgba(88, 101, 242, 0.1);
            color: var(--primary);
            border-left: 3px solid var(--primary);
        }
        
        /* Tournament Cards */
        .tournaments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 24px;
            margin-top: 30px;
        }
        
        .tournament-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }
        
        .tournament-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(88, 101, 242, 0.2);
        }
        
        .tournament-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .tournament-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .tournament-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-registration {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .status-ongoing {
            background: rgba(88, 101, 242, 0.1);
            color: var(--primary);
        }
        
        .tournament-meta {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 16px;
        }
        
        /* Bracket View */
        .bracket-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 24px;
            overflow-x: auto;
        }
        
        .bracket-rounds {
            display: flex;
            gap: 40px;
            min-width: min-content;
        }
        
        .bracket-round {
            min-width: 280px;
        }
        
        .round-title {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary);
            font-weight: 600;
            padding: 10px;
            background: rgba(88, 101, 242, 0.1);
            border-radius: 8px;
        }
        
        .match-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .match-teams {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .team {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-radius: 6px;
        }
        
        .team.winner {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        /* Forms */
        .form-container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 32px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--light);
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--light);
            font-size: 16px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        select.form-input {
            cursor: pointer;
        }
        
        /* Loading States */
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--gray);
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Error/Success Messages */
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            font-weight: 500;
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--success);
        }
        
        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--danger);
        }
        
        /* Server Select Items */
        .server-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
        }
        
        .server-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        
        .server-info {
            flex: 1;
        }
        
        .server-name {
            font-weight: 500;
        }
        
        .server-permission {
            font-size: 12px;
            color: var(--gray);
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 240px;
            }
            .main-content {
                margin-left: 240px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            .main-content {
                margin-left: 0;
                padding: 20px;
            }
            .tournaments-grid {
                grid-template-columns: 1fr;
            }
            .hero h1 {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container header-content">
            <div class="logo">
                <span>X</span>Tourney
            </div>
            <div class="auth-buttons" id="authButtons">
                <button class="btn btn-primary" onclick="loginWithDiscord()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px; vertical-align: middle;">
                        <path d="M20.317 4.37a19.791 19.791 0 00-4.885-1.515a.074.074 0 00-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 00-5.487 0a12.64 12.64 0 00-.617-1.25a.077.077 0 00-.079-.037A19.736 19.736 0 003.677 4.37a.07.07 0 00-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 00.031.057a19.9 19.9 0 005.993 3.03a.078.078 0 00.084-.028c.462-.63.872-1.295 1.226-1.994a.076.076 0 00-.041-.106a13.107 13.107 0 01-1.872-.892a.077.077 0 01-.008-.128c.125-.094.25-.188.372-.284a.076.076 0 01.077-.01c3.928 1.793 8.18 1.793 12.062 0a.076.076 0 01.078.01c.12.096.245.19.372.284a.077.077 0 01-.006.128a12.3 12.3 0 01-1.873.892a.077.077 0 00-.041.107c.36.698.77 1.362 1.225 1.993a.076.076 0 00.084.028a19.839 19.839 0 006.002-3.03a.077.077 0 00.032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 00-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
                    </svg>
                    Login with Discord
                </button>
            </div>
        </div>
    </header>

    <!-- Landing Page -->
    <section id="landingPage">
        <div class="hero">
            <div class="container">
                <h1>Professional Tournament Management</h1>
                <p>Create, manage, and track gaming tournaments with automated brackets, team registration, and real-time results.</p>
                <div style="display: flex; gap: 20px; justify-content: center; margin-top: 40px;">
                    <button class="btn btn-primary" onclick="loginWithDiscord()" style="padding: 16px 32px; font-size: 16px;">
                        Get Started Free
                    </button>
                    <button class="btn btn-secondary" onclick="inviteBot()" style="padding: 16px 32px; font-size: 16px;">
                        Add to Discord
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Dashboard (Hidden initially) -->
    <section id="dashboard" class="dashboard" style="display: none;">
        <div class="sidebar">
            <div style="margin-bottom: 40px;">
                <h3 style="color: var(--primary); margin-bottom: 20px;">Navigation</h3>
                <div class="nav-item active" onclick="showSection('overview')">
                    üìä Dashboard
                </div>
                <div class="nav-item" onclick="showSection('tournaments')">
                    üèÜ My Tournaments
                </div>
                <div class="nav-item" onclick="showSection('create')">
                    ‚ûï Create Tournament
                </div>
                <div class="nav-item" onclick="showSection('brackets')">
                    üìã Brackets
                </div>
                <div class="nav-item" onclick="showSection('teams')">
                    üë• Teams
                </div>
                <div class="nav-item" onclick="showSection('schedule')">
                    üóìÔ∏è Schedule
                </div>
            </div>
            
            <div style="border-top: 1px solid rgba(255, 255, 255, 0.1); padding-top: 30px;">
                <h4 style="color: var(--gray); margin-bottom: 15px;">Quick Stats</h4>
                <div style="color: var(--gray); font-size: 14px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Active Tournaments:</span>
                        <span id="statActive" style="color: var(--light);">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Total Teams:</span>
                        <span id="statTeams" style="color: var(--light);">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Servers:</span>
                        <span id="statServers" style="color: var(--light);">0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Overview Section -->
            <div id="overviewSection" class="section">
                <h2 style="margin-bottom: 30px;">Welcome to XTourney</h2>
                <div id="overviewContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading your dashboard...
                    </div>
                </div>
            </div>

            <!-- Tournaments Section -->
            <div id="tournamentsSection" class="section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2>My Tournaments</h2>
                    <button class="btn btn-primary" onclick="showSection('create')">
                        Create New
                    </button>
                </div>
                <div id="tournamentsContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading tournaments...
                    </div>
                </div>
            </div>

            <!-- Create Tournament Section -->
            <div id="createSection" class="section" style="display: none;">
                <h2 style="margin-bottom: 30px;">Create Tournament</h2>
                <div id="createContent">
                    <div class="form-container">
                        <div id="createAlert" class="alert" style="display: none;"></div>
                        <form id="createForm" onsubmit="event.preventDefault(); createTournament();">
                            <div class="form-group">
                                <label class="form-label">Discord Server</label>
                                <select id="serverSelect" class="form-input" required>
                                    <option value="">Select a server...</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Tournament Name</label>
                                <input type="text" id="tournamentName" class="form-input" 
                                       placeholder="Summer Championship 2024" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Game</label>
                                <input type="text" id="tournamentGame" class="form-input" 
                                       placeholder="Valorant, CS2, League of Legends" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Max Teams</label>
                                <select id="maxTeams" class="form-input" required>
                                    <option value="8">8 Teams</option>
                                    <option value="16" selected>16 Teams</option>
                                    <option value="32">32 Teams</option>
                                    <option value="64">64 Teams</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Bracket Type</label>
                                <select id="bracketType" class="form-input" required>
                                    <option value="single_elimination">Single Elimination</option>
                                    <option value="double_elimination">Double Elimination</option>
                                    <option value="round_robin">Round Robin</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Start Date & Time</label>
                                <input type="datetime-local" id="startDate" class="form-input" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Description</label>
                                <textarea id="description" class="form-input" rows="3" 
                                          placeholder="Tournament rules, prize pool, schedule..."></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 14px; font-size: 16px;">
                                Create Tournament
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Brackets Section -->
            <div id="bracketsSection" class="section" style="display: none;">
                <h2 style="margin-bottom: 30px;">Tournament Brackets</h2>
                <div id="bracketsContent">
                    <div style="margin-bottom: 30px;">
                        <select id="bracketTournamentSelect" class="form-input" style="width: 300px;" onchange="loadBracket(this.value)">
                            <option value="">Select a tournament...</option>
                        </select>
                    </div>
                    <div id="bracketDisplay">
                        <div class="loading">
                            Select a tournament to view brackets
                        </div>
                    </div>
                </div>
            </div>

            <!-- Teams Section -->
            <div id="teamsSection" class="section" style="display: none;">
                <h2 style="margin-bottom: 30px;">Team Management</h2>
                <div id="teamsContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading teams...
                    </div>
                </div>
            </div>

            <!-- Schedule Section -->
            <div id="scheduleSection" class="section" style="display: none;">
                <h2 style="margin-bottom: 30px;">Tournament Schedule</h2>
                <div id="scheduleContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading schedule...
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Auth Modal -->
    <div id="authModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: var(--darker); padding: 40px; border-radius: 12px; text-align: center; max-width: 500px; width: 90%; border: 1px solid rgba(255,255,255,0.1);">
            <div class="spinner" style="margin: 0 auto 20px;"></div>
            <h3 style="margin-bottom: 10px;">Connecting to Discord...</h3>
            <p style="color: var(--gray);">Please wait while we authenticate your account.</p>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION ==========
        const CONFIG = {
            API_URL: "https://compbot-lhuy.onrender.com", // Your Render URL
            DISCORD_CLIENT_ID: "1445127821742575726", // Your Discord Client ID
            REDIRECT_URI: "https://xotiicsplaza.us/", // Your website URL
            DISCORD_INVITE: "https://discord.com/oauth2/authorize?client_id=1445127821742575726&permissions=8&scope=bot%20applications.commands"
        };

        // ========== STATE ==========
        let currentUser = null;
        let userToken = null;
        let userServers = [];

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('XTourney loaded');
            
            // Check for auth callback
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            
            if (code) {
                handleAuthCallback(code);
            } else {
                // Check stored token
                const storedToken = localStorage.getItem('xtourney_token');
                if (storedToken) {
                    validateToken(storedToken);
                }
            }
            
            // Set default date/time (tomorrow 6 PM)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(18, 0, 0);
            const localDateTime = tomorrow.toISOString().slice(0, 16);
            document.getElementById('startDate').value = localDateTime;
        });

        // ========== DISCORD AUTHENTICATION ==========
        function loginWithDiscord() {
            const scope = 'identify email guilds';
            const state = generateState();
            localStorage.setItem('oauth_state', state);
            
            // Build Discord OAuth URL
            const authUrl = new URL('https://discord.com/api/oauth2/authorize');
            authUrl.searchParams.append('client_id', CONFIG.DISCORD_CLIENT_ID);
            authUrl.searchParams.append('redirect_uri', CONFIG.REDIRECT_URI);
            authUrl.searchParams.append('response_type', 'code');
            authUrl.searchParams.append('scope', scope);
            authUrl.searchParams.append('state', state);
            authUrl.searchParams.append('prompt', 'none');
            
            // Show loading modal
            document.getElementById('authModal').style.display = 'flex';
            
            // Redirect to Discord OAuth
            setTimeout(() => {
                window.location.href = authUrl.toString();
            }, 500);
        }

        async function handleAuthCallback(code) {
            try {
                console.log('Handling auth callback with code:', code);
                
                // Exchange code for token via YOUR backend
                const response = await fetch(`${CONFIG.API_URL}/api/auth/discord?code=${code}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Auth failed: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Auth response:', data);
                
                if (data.success) {
                    currentUser = data.user;
                    userToken = data.access_token;
                    userServers = data.servers || [];
                    
                    // Store in localStorage
                    localStorage.setItem('xtourney_token', userToken);
                    localStorage.setItem('xtourney_user', JSON.stringify(currentUser));
                    localStorage.setItem('xtourney_servers', JSON.stringify(userServers));
                    
                    // Update UI
                    showDashboard();
                    loadUserData();
                    
                    // Clean URL
                    window.history.replaceState({}, document.title, '/');
                    
                    showAlert('Successfully logged in!', 'success');
                } else {
                    throw new Error(data.detail || 'Authentication failed');
                }
            } catch (error) {
                console.error('Auth error:', error);
                showError('Login failed: ' + error.message);
            } finally {
                document.getElementById('authModal').style.display = 'none';
            }
        }

        async function validateToken(token) {
            try {
                const response = await fetch(`${CONFIG.API_URL}/api/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser = JSON.parse(localStorage.getItem('xtourney_user')) || data.user;
                    userToken = token;
                    userServers = JSON.parse(localStorage.getItem('xtourney_servers') || '[]');
                    
                    showDashboard();
                    loadUserData();
                } else {
                    logout();
                }
            } catch (error) {
                console.error('Token validation error:', error);
                logout();
            }
        }

        // ========== DASHBOARD FUNCTIONS ==========
        function showDashboard() {
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            // Update auth buttons
            const authButtons = document.getElementById('authButtons');
            authButtons.innerHTML = `
                <div class="user-profile">
                    <img src="${currentUser.avatar || 'https://cdn.discordapp.com/embed/avatars/0.png'}" 
                         alt="Avatar" class="user-avatar" 
                         onerror="this.src='https://cdn.discordapp.com/embed/avatars/0.png'">
                    <div class="user-info">
                        <div class="user-name">${currentUser.username || 'User'}</div>
                        <div class="user-role">Tournament Host</div>
                    </div>
                    <button onclick="logout()" style="margin-left: 10px; padding: 6px 12px; background: var(--danger); color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">
                        Logout
                    </button>
                </div>
            `;
            
            // Load servers dropdown
            loadServersDropdown();
        }

        function loadServersDropdown() {
            const select = document.getElementById('serverSelect');
            select.innerHTML = '<option value="">Select a server...</option>';
            
            if (!userServers || userServers.length === 0) {
                select.innerHTML += '<option value="" disabled>No servers found</option>';
                return;
            }
            
            // Filter servers where user has ADMINISTRATOR permission (0x8)
            const adminServers = userServers.filter(server => {
                const permissions = parseInt(server.permissions);
                return (permissions & 0x8) === 0x8; // Check for ADMINISTRATOR permission
            });
            
            if (adminServers.length === 0) {
                select.innerHTML += '<option value="" disabled>No servers with admin permission</option>';
                return;
            }
            
            adminServers.forEach(server => {
                const option = document.createElement('option');
                option.value = server.id;
                option.innerHTML = `
                    <div class="server-option">
                        ${server.icon ? 
                            `<img src="${server.icon}" alt="${server.name}" style="width: 20px; height: 20px; border-radius: 50%;">` :
                            `<div class="server-icon">${server.name.charAt(0)}</div>`
                        }
                        <div class="server-info">
                            <div class="server-name">${server.name}</div>
                            <div class="server-permission">Administrator</div>
                        </div>
                    </div>
                `;
                select.appendChild(option);
            });
            
            // Update stats
            document.getElementById('statServers').textContent = adminServers.length;
        }

        async function loadUserData() {
            if (!currentUser || !userToken) return;
            
            try {
                // Load tournaments
                const response = await fetch(`${CONFIG.API_URL}/api/tournaments`, {
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Tournaments data:', data);
                    
                    if (data.tournaments) {
                        updateStats(data.tournaments);
                        renderTournaments(data.tournaments);
                        updateBracketSelect(data.tournaments);
                    }
                } else {
                    console.error('Failed to load tournaments:', response.status);
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showError('Failed to load tournaments: ' + error.message);
            }
        }

        // ========== TOURNAMENT MANAGEMENT ==========
        async function createTournament() {
            const form = document.getElementById('createForm');
            const alertDiv = document.getElementById('createAlert');
            
            const tournamentData = {
                name: document.getElementById('tournamentName').value,
                game: document.getElementById('tournamentGame').value,
                description: document.getElementById('description').value,
                max_teams: parseInt(document.getElementById('maxTeams').value),
                bracket_type: document.getElementById('bracketType').value,
                start_date: document.getElementById('startDate').value,
                discord_server_id: document.getElementById('serverSelect').value
            };
            
            // Validation
            if (!tournamentData.discord_server_id) {
                showAlert('Please select a Discord server', 'error');
                return;
            }
            
            if (!tournamentData.name || !tournamentData.game) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${CONFIG.API_URL}/api/tournaments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify(tournamentData)
                });
                
                const data = await response.json();
                console.log('Create tournament response:', data);
                
                if (response.ok && data.success) {
                    showAlert('Tournament created successfully!', 'success');
                    
                    // Reset form
                    form.reset();
                    
                    // Set default date
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    tomorrow.setHours(18, 0, 0);
                    document.getElementById('startDate').value = tomorrow.toISOString().slice(0, 16);
                    
                    // Reload user data
                    setTimeout(() => {
                        loadUserData();
                        showSection('tournaments');
                    }, 1000);
                } else {
                    throw new Error(data.detail || 'Failed to create tournament');
                }
            } catch (error) {
                console.error('Create tournament error:', error);
                showAlert('Error: ' + error.message, 'error');
            }
        }

        // ========== BRACKET MANAGEMENT ==========
        async function loadBracket(tournamentId) {
            if (!tournamentId) return;
            
            const bracketDisplay = document.getElementById('bracketDisplay');
            bracketDisplay.innerHTML = '<div class="loading"><div class="spinner"></div>Loading bracket...</div>';
            
            try {
                const response = await fetch(`${CONFIG.API_URL}/api/tournaments/${tournamentId}/bracket`, {
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load bracket');
                }
                
                const data = await response.json();
                renderBracket(data);
            } catch (error) {
                console.error('Load bracket error:', error);
                bracketDisplay.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        }

        function renderBracket(data) {
            const { tournament, rounds = {}, teams = [] } = data;
            const bracketDisplay = document.getElementById('bracketDisplay');
            
            let html = `
                <div style="margin-bottom: 30px;">
                    <h3>${tournament.name} - ${tournament.game}</h3>
                    <p style="color: var(--gray); margin-top: 10px;">${tournament.description || 'No description provided'}</p>
                    <div style="display: flex; gap: 20px; margin-top: 20px;">
                        <span>Status: <strong>${tournament.status.toUpperCase()}</strong></span>
                        <span>Teams: <strong>${tournament.current_teams}/${tournament.max_teams}</strong></span>
                        <span>Type: <strong>${tournament.bracket_type.replace('_', ' ').toUpperCase()}</strong></span>
                    </div>
                </div>
            `;
            
            const roundNumbers = Object.keys(rounds).sort((a, b) => a - b);
            
            if (roundNumbers.length > 0) {
                html += `<div class="bracket-container"><div class="bracket-rounds">`;
                
                roundNumbers.forEach(roundNum => {
                    const roundMatches = rounds[roundNum];
                    
                    html += `
                        <div class="bracket-round">
                            <div class="round-title">Round ${roundNum}</div>
                            ${roundMatches.map(match => `
                                <div class="match-card">
                                    <div class="match-teams">
                                        <div class="team ${match.winner_id === match.team1_id ? 'winner' : ''}">
                                            <span>${getTeamName(match.team1_id, teams) || `Team ${match.match_number}A`}</span>
                                            <span style="color: var(--primary); font-weight: bold;">${match.score_team1}</span>
                                        </div>
                                        <div class="team ${match.winner_id === match.team2_id ? 'winner' : ''}">
                                            <span>${getTeamName(match.team2_id, teams) || `Team ${match.match_number}B`}</span>
                                            <span style="color: var(--primary); font-weight: bold;">${match.score_team2}</span>
                                        </div>
                                    </div>
                                    ${match.scheduled_time ? `
                                        <div style="text-align: center; margin-top: 10px; font-size: 12px; color: var(--gray);">
                                            ${new Date(match.scheduled_time).toLocaleString()}
                                        </div>
                                    ` : ''}
                                    <div style="text-align: center; margin-top: 10px;">
                                        <span style="padding: 4px 8px; background: ${getMatchStatusColor(match.status)}; border-radius: 4px; font-size: 11px;">
                                            ${match.status.toUpperCase()}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            } else {
                html += `
                    <div style="text-align: center; padding: 60px; color: var(--gray);">
                        <p style="margin-bottom: 20px;">No bracket generated yet.</p>
                        <p>Teams need to register first.</p>
                    </div>
                `;
            }
            
            bracketDisplay.innerHTML = html;
        }

        function getTeamName(teamId, teams) {
            if (!teamId) return null;
            const team = teams.find(t => t.id === teamId);
            return team ? team.name : null;
        }

        function getMatchStatusColor(status) {
            const colors = {
                'pending': 'var(--warning)',
                'ongoing': 'var(--primary)',
                'completed': 'var(--success)',
                'cancelled': 'var(--danger)'
            };
            return colors[status] || 'var(--gray)';
        }

        // ========== UI HELPERS ==========
        function updateStats(tournaments) {
            const active = tournaments.filter(t => t.status === 'registration' || t.status === 'ongoing').length;
            const totalTeams = tournaments.reduce((sum, t) => sum + (t.current_teams || 0), 0);
            
            document.getElementById('statActive').textContent = active;
            document.getElementById('statTeams').textContent = totalTeams;
        }

        function renderTournaments(tournaments) {
            const container = document.getElementById('tournamentsContent');
            
            if (!tournaments || tournaments.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--gray);">
                        <p style="margin-bottom: 20px;">No tournaments yet</p>
                        <button class="btn btn-primary" onclick="showSection('create')">
                            Create Your First Tournament
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="tournaments-grid">';
            
            tournaments.forEach(tournament => {
                html += `
                    <div class="tournament-card">
                        <div class="tournament-header">
                            <div class="tournament-title">${tournament.name}</div>
                            <div class="tournament-status status-${tournament.status}">
                                ${tournament.status.toUpperCase()}
                            </div>
                        </div>
                        <div class="tournament-meta">
                            ${tournament.game} ‚Ä¢ ${tournament.current_teams || 0}/${tournament.max_teams} teams
                        </div>
                        <p style="color: var(--gray); font-size: 14px; margin-bottom: 20px;">
                            ${tournament.description || 'No description'}
                        </p>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="viewTournament('${tournament.id}')" class="btn btn-secondary" style="flex: 1; padding: 8px;">
                                View Bracket
                            </button>
                            <button onclick="manageTournament('${tournament.id}')" class="btn btn-primary" style="flex: 1; padding: 8px;">
                                Manage
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function updateBracketSelect(tournaments) {
            const select = document.getElementById('bracketTournamentSelect');
            select.innerHTML = '<option value="">Select a tournament...</option>';
            
            if (!tournaments) return;
            
            tournaments.forEach(tournament => {
                const option = document.createElement('option');
                option.value = tournament.id;
                option.textContent = `${tournament.name} (${tournament.game})`;
                select.appendChild(option);
            });
        }

        function viewTournament(tournamentId) {
            showSection('brackets');
            loadBracket(tournamentId);
            document.getElementById('bracketTournamentSelect').value = tournamentId;
        }

        function manageTournament(tournamentId) {
            showAlert('Tournament management features coming soon!', 'success');
        }

        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            const section = document.getElementById(`${sectionName}Section`);
            if (section) {
                section.style.display = 'block';
            }
            
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate corresponding nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.textContent.trim().toLowerCase().includes(sectionName.toLowerCase())) {
                    item.classList.add('active');
                }
            });
            
            // Load data for the section
            if (sectionName === 'overview') {
                loadUserData();
            } else if (sectionName === 'tournaments') {
                loadUserData();
            }
        }

        // ========== UTILITY FUNCTIONS ==========
        function showAlert(message, type = 'success') {
            const alertDiv = document.getElementById('createAlert');
            if (!alertDiv) return;
            
            alertDiv.style.display = 'block';
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.animation = 'fadeIn 0.3s';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-error';
            errorDiv.textContent = message;
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '20px';
            errorDiv.style.right = '20px';
            errorDiv.style.zIndex = '3000';
            errorDiv.style.maxWidth = '400px';
            errorDiv.style.padding = '15px';
            errorDiv.style.borderRadius = '8px';
            errorDiv.style.animation = 'fadeIn 0.3s';
            
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.style.opacity = '0';
                errorDiv.style.transition = 'opacity 0.3s';
                setTimeout(() => errorDiv.remove(), 300);
            }, 5000);
        }

        function generateState() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        function logout() {
            localStorage.removeItem('xtourney_token');
            localStorage.removeItem('xtourney_user');
            localStorage.removeItem('xtourney_servers');
            
            currentUser = null;
            userToken = null;
            userServers = [];
            
            document.getElementById('landingPage').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            
            // Reset auth buttons
            const authButtons = document.getElementById('authButtons');
            authButtons.innerHTML = `
                <button class="btn btn-primary" onclick="loginWithDiscord()">
                    Login with Discord
                </button>
            `;
            
            // Clear URL
            window.history.replaceState({}, document.title, window.location.pathname);
            
            showAlert('Successfully logged out', 'success');
        }

        function inviteBot() {
            window.open(CONFIG.DISCORD_INVITE, '_blank');
        }

        // Add CSS animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>

